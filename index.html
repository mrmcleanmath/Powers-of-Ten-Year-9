<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calculations with Powers â€“ Year 9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #f5f5f5;
      --bg-alt: #ffffff;
      --fg: #222222;
      --fg-soft: #555555;
      --accent: #2b7cff;
      --accent-soft: #e2ecff;
      --accent-dark: #1d57b5;
      --error: #c62828;
      --success: #2e7d32;
      --border: #dddddd;
      --card-radius: 12px;
      --shadow-soft: 0 2px 6px rgba(0,0,0,0.1);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--fg);
    }

    body.high-contrast {
      --bg: #000000;
      --bg-alt: #111111;
      --fg: #ffffff;
      --fg-soft: #e0e0e0;
      --accent: #ffff00;
      --accent-soft: #333333;
      --accent-dark: #ffeb3b;
      --border: #555555;
      --error: #ff5252;
      --success: #69f0ae;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    header p {
      margin: 4px 0 0 0;
      color: var(--fg-soft);
      font-size: 0.95rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-alt);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .controls-row label {
      font-size: 0.9rem;
      color: var(--fg-soft);
    }

    .chip-group {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.85rem;
      background: #ffffff;
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip span.emoji {
      font-size: 1rem;
    }

    .chip.active {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent-dark);
    }

    .chip.mode-chip {
      border-radius: 8px;
    }

    select, input[type="number"] {
      font-size: 0.9rem;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--fg);
    }

    button {
      padding: 6px 14px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.secondary {
      background: transparent;
      color: var(--accent-dark);
      border: 1px solid var(--accent-dark);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
    }

    .toggle input {
      accent-color: var(--accent);
    }

    .mode-tabs {
      display: inline-flex;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .mode-tab {
      padding: 4px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      background: #ffffff;
      border-right: 1px solid var(--border);
      user-select: none;
    }

    .mode-tab:last-child {
      border-right: none;
    }

    .mode-tab.active {
      background: var(--accent);
      color: #ffffff;
    }

    .task-label {
      text-align: center;
      font-size: 0.95rem;
      color: var(--fg-soft);
      margin-bottom: 4px;
      min-height: 1.2em;
    }

    .question-area {
      font-size: 1.4rem;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .answer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .answer-row input[type="text"] {
      flex: 1;
      min-width: 140px;
      font-size: 1.1rem;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .feedback {
      min-height: 22px;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .feedback.correct {
      color: var(--success);
    }

    .feedback.incorrect {
      color: var(--error);
    }

    .explanation {
      font-size: 0.9rem;
      color: var(--fg-soft);
      margin-top: 4px;
    }

    .explanation.hidden {
      display: none;
    }

    .summary {
      font-size: 0.9rem;
    }

    .summary strong {
      font-weight: 600;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 6px;
    }

    .summary-row span {
      margin-right: 6px;
    }

    .incorrect-list {
      margin-top: 4px;
      display: none;
      font-size: 0.85rem;
    }

    .incorrect-list ul {
      margin: 4px 0 0 16px;
      padding: 0;
    }

    .incorrect-toggle {
      font-size: 0.85rem;
      color: var(--accent-dark);
      cursor: pointer;
      margin-top: 4px;
      display: inline-block;
    }

    .timer-display {
      font-size: 0.95rem;
      font-weight: 600;
      margin-left: auto;
    }

    .flex-spacer {
      flex: 1;
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: var(--fg-soft);
      margin: 14px 0 4px;
    }

    .worksheet-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .worksheet-output {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
      max-height: 360px;
      overflow-y: auto;
      background: #ffffff;
      font-size: 1rem;
    }

    .worksheet-output h3 {
      margin-top: 0;
      font-size: 1rem;
      text-align: center;
    }

    .worksheet-item {
      margin-bottom: 12px;
      cursor: pointer;
    }

    .worksheet-answer {
      font-size: 0.9rem;
      color: var(--fg-soft);
      display: none;
      margin-left: 18px;
    }

    .worksheet-answer.visible {
      display: block;
    }

    .worksheet-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .power {
      display: inline-flex;
      align-items: flex-start;
    }

    .power .base {
      font-size: 1em;
    }

    .power .sup {
      font-size: 0.65em;
      vertical-align: top;
      padding-left: 1px;
    }

    .op {
      display: inline-block;
      padding: 0 0.3em;
    }

    .frac {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      font-size: 0.95em;
    }

    .frac .num,
    .frac .den {
      display: block;
      padding: 0 2px;
    }

    .frac .bar {
      display: block;
      border-top: 1px solid currentColor;
      width: 100%;
      margin: 1px 0;
    }

    .equation {
      font-size: 1.1em;
    }

    #devTests {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--fg-soft);
      border-top: 1px dashed var(--border);
      padding-top: 6px;
      display: none;
      max-height: 220px;
      overflow-y: auto;
    }

    #devTests .pass {
      color: var(--success);
    }

    #devTests .fail {
      color: var(--error);
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Calculations with Powers â€“ Year 9</h1>
    <p>Practice simplifying powers and solving for x, modeled on textbook pages 29â€“31.</p>
  </header>

  <div class="layout">
    <div class="card">
      <div class="controls-row">
        <div class="mode-tabs" id="mainModeTabs">
          <div class="mode-tab active" data-main-mode="game">Game</div>
          <div class="mode-tab" data-main-mode="worksheet">Worksheet</div>
        </div>
        <div class="flex-spacer"></div>
        <label class="toggle">
          <input type="checkbox" id="highContrastToggle">
          High contrast
        </label>
      </div>

      <div id="gamePane">
        <div class="controls-row">
          <label>Difficulty:</label>
          <div class="chip-group" id="difficultyChips">
            <div class="chip active" data-diff="easy"><span class="emoji">ðŸŸ¢</span>Easy</div>
            <div class="chip" data-diff="medium"><span class="emoji">ðŸŸ¡</span>Medium</div>
            <div class="chip" data-diff="hard"><span class="emoji">ðŸ”´</span>Hard</div>
            <div class="chip" data-diff="random"><span class="emoji">ðŸŽ²</span>Random</div>
          </div>
        </div>

        <div class="controls-row">
          <label>Problem type:</label>
          <div class="chip-group" id="problemModeChips">
            <div class="chip mode-chip active" data-mode="simplify">Simplify powers</div>
            <div class="chip mode-chip" data-mode="solve">Solve for x</div>
            <div class="chip mode-chip" data-mode="mixed">Mixed</div>
          </div>
        </div>

        <div class="controls-row">
          <label class="toggle">
            <input type="checkbox" id="soundToggle" checked>
            Sound
          </label>
          <label class="toggle">
            <input type="checkbox" id="timerToggle">
            Timer
          </label>
          <select id="timerLengthSelect">
            <option value="30">30 s</option>
            <option value="60" selected>60 s</option>
            <option value="90">90 s</option>
            <option value="120">120 s</option>
          </select>
          <div class="flex-spacer"></div>
          <div class="timer-display" id="timerDisplay"></div>
        </div>

        <div class="task-label" id="taskLabel"></div>

        <div class="question-area" id="questionArea">
          Click "Next question" to begin.
        </div>

        <div class="answer-row">
          <input type="text" id="answerInput" placeholder="Type your answer (e.g. 10^5 or 100 000)">
          <button id="submitBtn">Submit</button>
          <button class="secondary" id="nextBtn">Next question</button>
          <button class="secondary" id="clearBtn">Clear</button>
        </div>

        <div class="feedback" id="feedback"></div>
        <button class="secondary" id="showStepsBtn" style="display:none;">Show steps</button>
        <div class="explanation hidden" id="explanation"></div>

        <div class="summary" id="summary">
          <div class="summary-row">
            <span><strong>Questions:</strong> <span id="statTotal">0</span></span>
            <span><strong>Correct:</strong> <span id="statCorrect">0</span></span>
            <span><strong>Accuracy:</strong> <span id="statAccuracy">0%</span></span>
            <span><strong>Score:</strong> <span id="statScore">0</span></span>
            <span><strong>Streak:</strong> <span id="statStreak">0</span></span>
          </div>
          <div class="incorrect-toggle" id="incorrectToggle">Show incorrect questions</div>
          <div class="incorrect-list" id="incorrectList"></div>
        </div>
      </div>

      <div id="worksheetPane" style="display:none; margin-top:8px;">
        <div class="worksheet-controls">
          <label>Difficulty:
            <select id="wsDifficulty">
              <option value="easy">ðŸŸ¢ Easy</option>
              <option value="medium">ðŸŸ¡ Medium</option>
              <option value="hard">ðŸ”´ Hard</option>
              <option value="random">ðŸŽ² Random</option>
            </select>
          </label>
          <label>Problem type:
            <select id="wsProblemMode">
              <option value="simplify">Simplify powers</option>
              <option value="solve">Solve for x</option>
              <option value="mixed" selected>Mixed</option>
            </select>
          </label>
          <label>Questions:
            <select id="wsCount">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="15">15</option>
            </select>
          </label>
          <button id="generateWorksheetBtn">Generate</button>
        </div>

        <div class="worksheet-buttons">
          <button class="secondary" id="wsRevealAllBtn">Reveal all</button>
          <button class="secondary" id="wsHideAllBtn">Hide all</button>
        </div>

        <div class="worksheet-output" id="worksheetOutput">
          <h3>Worksheet</h3>
          <p style="font-size:0.9rem; color:var(--fg-soft); text-align:center;">
            Choose settings above and click "Generate" to create a worksheet.
          </p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Instructions</h2>
      <p style="font-size:0.9rem; color:var(--fg-soft);">
        This game practices the rules for powers:
      </p>
      <ul style="font-size:0.9rem; color:var(--fg-soft);">
        <li><span class="power"><span class="base">a</span><span class="sup">m</span></span> <span class="op">Â·</span> <span class="power"><span class="base">a</span><span class="sup">n</span></span> = <span class="power"><span class="base">a</span><span class="sup">m+n</span></span></li>
        <li><span class="frac"><span class="num"><span class="power"><span class="base">a</span><span class="sup">m</span></span></span><span class="bar"></span><span class="den"><span class="power"><span class="base">a</span><span class="sup">n</span></span></span></span> = <span class="power"><span class="base">a</span><span class="sup">m-n</span></span></li>
        <li>(<span class="power"><span class="base">a</span><span class="sup">m</span></span>)<span class="sup">n</span> = <span class="power"><span class="base">a</span><span class="sup">mÂ·n</span></span></li>
      </ul>
      <p style="font-size:0.9rem; color:var(--fg-soft);">
        Type powers as <code>a^n</code>. For example, <code>10^5</code> or <code>100000</code> are both accepted and counted as correct, but the model answer is shown as <code>10^5</code>.
      </p>
      <p style="font-size:0.9rem; color:var(--fg-soft);">
        For fractions, type <code>a/b</code>. They are always displayed with a horizontal bar, like in the textbook.
      </p>
      <p style="font-size:0.9rem; color:var(--fg-soft);">
        Keyboard shortcuts: Enter = Submit / Next (on correct), Esc = Clear.
      </p>

      <div id="devTests"></div>
    </div>
  </div>

  <footer>Created by Mr. McLean Math</footer>
</div>

<script>
(function() {
  "use strict";

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function choose(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function gcd(a, b) {
    a = Math.abs(a); b = Math.abs(b);
    while (b !== 0) {
      var t = b;
      b = a % b;
      a = t;
    }
    return a || 1;
  }

  function formatIntegerSpaces(n) {
    var negative = n < 0;
    var s = Math.abs(n).toString();
    var out = "";
    var count = 0;
    for (var i = s.length - 1; i >= 0; i--) {
      out = s[i] + out;
      count++;
      if (count === 3 && i !== 0) {
        out = " " + out;
        count = 0;
      }
    }
    return negative ? "-" + out : out;
  }

  function createPowerHTML(base, exp) {
    return '<span class="power"><span class="base">' +
      base + '</span><span class="sup">' + exp + '</span></span>';
  }

  function createDotHTML() {
    return '<span class="op">Â·</span>';
  }

  function createFractionHTML(numHTML, denHTML) {
    return '<span class="frac"><span class="num">' +
      numHTML + '</span><span class="bar"></span><span class="den">' +
      denHTML + '</span></span>';
  }

  function escapeHTML(s) {
    return s.replace(/[&<>]/g, function(c) {
      return c === "&" ? "&amp;" : c === "<" ? "&lt;" : "&gt;";
    });
  }

  function parsePowerAnswer(str) {
    var s = str.trim();
    if (!s) return null;
    s = s.replace(/\s+/g, " ");
    var caretIndex = s.indexOf("^");
    if (caretIndex !== -1) {
      var left = s.slice(0, caretIndex).trim();
      var right = s.slice(caretIndex + 1).trim();
      if (!left || !right) return null;
      var base = parseInt(left.replace(/\s+/g, ""), 10);
      var exp = parseInt(right.replace(/\s+/g, ""), 10);
      if (!isFinite(base) || isNaN(base) || isNaN(exp)) return null;
      return { type: "power", base: base, exp: exp };
    }
    var numeric = s.replace(/\s+/g, "");
    var val = parseInt(numeric, 10);
    if (isNaN(val)) return null;
    return { type: "integer", value: val };
  }

  function parseFractionAnswer(str) {
    var s = str.trim();
    if (!s) return null;
    s = s.replace(/\s+/g, "");
    var parts = s.split("/");
    if (parts.length !== 2) return null;
    var num = parseInt(parts[0], 10);
    var den = parseInt(parts[1], 10);
    if (isNaN(num) || isNaN(den) || den === 0) return null;
    var g = gcd(num, den);
    num /= g; den /= g;
    if (den < 0) { den = -den; num = -num; }
    return { num: num, den: den };
  }

  var BASES = [2, 3, 4, 5, 7, 10];

  function getExponentBounds(difficulty) {
    if (difficulty === "easy") {
      return { expMin: 0, expMax: 4, finalMin: 0, finalMax: 4, allowNegative: false };
    }
    if (difficulty === "medium") {
      return { expMin: 0, expMax: 5, finalMin: 0, finalMax: 5, allowNegative: false };
    }
    return { expMin: 0, expMax: 6, finalMin: -3, finalMax: 6, allowNegative: true };
  }

  function generateSimplifyProblem(difficulty) {
    var bounds = getExponentBounds(difficulty);
    var base = choose(BASES);
    var kind, expResult, promptHTML, explanation;

    function withinBounds(e) {
      return e >= bounds.finalMin && e <= bounds.finalMax &&
        (!bounds.allowNegative ? e >= 0 : true);
    }

    for (var attempts = 0; attempts < 80; attempts++) {
      base = choose(BASES);
      if (difficulty === "easy") {
        kind = choose(["mul2", "div2", "bothSides"]);
      } else if (difficulty === "medium") {
        kind = choose(["mul2", "div2", "mixed3", "bothSides", "powerOfPower"]);
      } else {
        kind = choose(["mul2", "div2", "mixed3", "bothSides", "powerOfPower"]);
      }

      var exp1, exp2, exp3, exp4, expA, expB;

      if (kind === "mul2") {
        exp1 = randInt(bounds.expMin, bounds.expMax);
        exp2 = randInt(bounds.expMin, bounds.expMax);
        expResult = exp1 + exp2;
        if (!withinBounds(expResult)) continue;
        promptHTML = createPowerHTML(base, exp1) +
                     createDotHTML() +
                     createPowerHTML(base, exp2);
        explanation =
          "Multiply powers with the same base by adding exponents: " +
          exp1 + " + " + exp2 + " = " + expResult + ".";
        break;

      } else if (kind === "div2") {
        exp1 = randInt(bounds.expMin, bounds.expMax);
        exp2 = randInt(bounds.expMin, bounds.expMax);
        if (!bounds.allowNegative && exp1 < exp2) {
          var tmp = exp1; exp1 = exp2; exp2 = tmp;
        }
        expResult = exp1 - exp2;
        if (!withinBounds(expResult)) continue;
        var num = createPowerHTML(base, exp1);
        var den = createPowerHTML(base, exp2);
        promptHTML = createFractionHTML(num, den);
        explanation =
          "Divide powers with the same base by subtracting exponents: " +
          exp1 + " - " + exp2 + " = " + expResult + ".";
        break;

      } else if (kind === "mixed3") {
        var pattern = choose(["mulDiv", "divMul"]);
        exp1 = randInt(bounds.expMin, bounds.expMax);
        exp2 = randInt(bounds.expMin, bounds.expMax);
        exp3 = randInt(bounds.expMin, bounds.expMax);

        if (pattern === "mulDiv") {
          expResult = exp1 + exp2 - exp3;
          if (!withinBounds(expResult)) continue;
          var numMD = createPowerHTML(base, exp1) +
                      createDotHTML() +
                      createPowerHTML(base, exp2);
          var denMD = createPowerHTML(base, exp3);
          promptHTML = createFractionHTML(numMD, denMD);
          explanation =
            "First add exponents in the numerator, then subtract the denominator exponent: (" +
            exp1 + " + " + exp2 + ") - " + exp3 + " = " + expResult + ".";
        } else {
          expResult = exp1 - exp2 - exp3;
          if (!withinBounds(expResult)) continue;
          var numDM = createPowerHTML(base, exp1);
          var denDM = createPowerHTML(base, exp2) +
                      createDotHTML() +
                      createPowerHTML(base, exp3);
          promptHTML = createFractionHTML(numDM, denDM);
          explanation =
            "Subtract both exponents in the denominator: " +
            exp1 + " - " + exp2 + " - " + exp3 + " = " + expResult + ".";
        }
        break;

      } else if (kind === "bothSides") {
        exp1 = randInt(bounds.expMin, bounds.expMax);
        exp2 = randInt(bounds.expMin, bounds.expMax);
        exp3 = randInt(bounds.expMin, bounds.expMax);
        exp4 = randInt(bounds.expMin, bounds.expMax);
        expResult = (exp1 + exp2) - (exp3 + exp4);
        if (!withinBounds(expResult)) continue;
        var numBS = createPowerHTML(base, exp1) +
                    createDotHTML() +
                    createPowerHTML(base, exp2);
        var denBS = createPowerHTML(base, exp3) +
                    createDotHTML() +
                    createPowerHTML(base, exp4);
        promptHTML = createFractionHTML(numBS, denBS);
        explanation =
          "Add exponents in the numerator and denominator, then subtract: (" +
          exp1 + " + " + exp2 + ") - (" + exp3 + " + " + exp4 + ") = " +
          expResult + ".";
        break;

      } else if (kind === "powerOfPower") {
        expA = randInt(1, bounds.expMax || 5);
        expB = randInt(2, difficulty === "easy" ? 3 : 4);
        expResult = expA * expB;
        if (!withinBounds(expResult)) continue;
        promptHTML = "(" + createPowerHTML(base, expA) + ")" +
                     '<span class="sup">' + expB + "</span>";
        explanation =
          "For a power of a power, multiply exponents: " +
          expA + " Â· " + expB + " = " + expResult + ".";
        break;
      }
    }

    if (!promptHTML) {
      base = 10; expResult = 3;
      promptHTML = createPowerHTML(10, 1) +
                   createDotHTML() +
                   createPowerHTML(10, 2);
      explanation = "Fallback problem.";
    }

    var powerValue = Math.pow(base, expResult);

    return {
      type: "simplify",
      difficulty: difficulty,
      promptHTML: promptHTML,
      answer: {
        kind: "power",
        base: base,
        exp: expResult,
        value: powerValue
      },
      explanationHTML: explanation +
        " So the result is " + createPowerHTML(base, expResult) + "."
    };
  }

  function generateSolveForXProblem(difficulty) {
    var bounds = getExponentBounds(difficulty);
    var base = choose(BASES);
    var promptHTML, explanation, xValue;

    function withinExpRange(e) {
      return e >= bounds.finalMin && e <= bounds.finalMax &&
        (!bounds.allowNegative ? e >= 0 : true);
    }

    for (var attempts = 0; attempts < 80; attempts++) {
      base = choose(BASES);
      var pattern;
      if (difficulty === "easy") {
        pattern = choose(["mulSimple", "divSimple", "fracNumX", "fracDenX"]);
      } else if (difficulty === "medium") {
        pattern = choose(["mulSimple", "divSimple", "mulThree", "fracBothX"]);
      } else {
        pattern = choose(["mulSimple", "divSimple", "mulThree", "balance", "fracBothX", "twoX"]);
      }

      var a, b, c, p, q, r, s, leftExp, rightExp;

      if (pattern === "mulSimple") {
        a = randInt(bounds.expMin, bounds.expMax);
        b = randInt(bounds.expMin + 1, bounds.expMax + 2);
        xValue = b - a;
        if (xValue < -5 || xValue > 10) continue;
        if (!withinExpRange(b)) continue;
        var left = createPowerHTML(base, "x") +
                   createDotHTML() +
                   createPowerHTML(base, a);
        var right = createPowerHTML(base, b);
        promptHTML = left + " = " + right;
        explanation =
          "Add exponents on the left: x + " + a +
          ". This must equal " + b + ", so x = " + xValue + ".";
        break;

      } else if (pattern === "divSimple") {
        a = randInt(bounds.expMin, bounds.expMax);
        b = randInt(bounds.finalMin, bounds.finalMax);
        xValue = b + a;
        if (xValue < -5 || xValue > 10) continue;
        if (!withinExpRange(b)) continue;
        var num = createPowerHTML(base, "x");
        var den = createPowerHTML(base, a);
        var frac = createFractionHTML(num, den);
        promptHTML = frac + " = " + createPowerHTML(base, b);
        explanation =
          "Subtract exponents in the fraction: x - " + a +
          " = " + b + ". So x = " + xValue + ".";
        break;

      } else if (pattern === "mulThree") {
        a = randInt(bounds.expMin, bounds.expMax);
        b = randInt(bounds.expMin, bounds.expMax);
        c = randInt(bounds.expMin + 1, bounds.expMax + 3);
        xValue = c - a - b;
        if (xValue < -5 || xValue > 10) continue;
        if (!withinExpRange(c)) continue;
        var left3 = createPowerHTML(base, "x") +
                    createDotHTML() +
                    createPowerHTML(base, a) +
                    createDotHTML() +
                    createPowerHTML(base, b);
        var right3 = createPowerHTML(base, c);
        promptHTML = left3 + " = " + right3;
        explanation =
          "Add all exponents on the left: x + " + a + " + " + b +
          " = " + c + ". So x = " + xValue + ".";
        break;

      } else if (pattern === "balance") {
        var k = randInt(1, 4);
        xValue = k;
        var leftB = createPowerHTML(base, "x") +
                    createDotHTML() +
                    createPowerHTML(base, k);
        var rightB = createPowerHTML(base, "2x");
        promptHTML = leftB + " = " + rightB;
        explanation =
          "Add exponents on the left: x + " + k +
          ". On the right we have 2x. So x + " + k +
          " = 2x, which gives x = " + xValue + ".";
        break;

      } else if (pattern === "fracNumX") {
        // (a^x * a^p) / a^q = a^r
        p = randInt(bounds.expMin, bounds.expMax);
        q = randInt(bounds.expMin, bounds.expMax);
        r = randInt(bounds.finalMin, bounds.finalMax);
        xValue = r - p + q;
        if (xValue < -5 || xValue > 10) continue;
        if (!withinExpRange(r)) continue;
        var numFN = createPowerHTML(base, "x") +
                    createDotHTML() +
                    createPowerHTML(base, p);
        var denFN = createPowerHTML(base, q);
        var fracFN = createFractionHTML(numFN, denFN);
        promptHTML = fracFN + " = " + createPowerHTML(base, r);
        explanation =
          "Exponent rule: x + " + p + " - " + q + " = " + r +
          ". So x = " + xValue + ".";
        break;

      } else if (pattern === "fracDenX") {
        // a^p / (a^x * a^q) = a^r
        p = randInt(bounds.expMin + 1, bounds.expMax + 1);
        q = randInt(bounds.expMin, bounds.expMax);
        r = randInt(bounds.finalMin, bounds.finalMax);
        xValue = p - q - r;
        if (xValue < -5 || xValue > 10) continue;
        if (!withinExpRange(r)) continue;
        var numFD = createPowerHTML(base, p);
        var denFD = createPowerHTML(base, "x") +
                    createDotHTML() +
                    createPowerHTML(base, q);
        var fracFD = createFractionHTML(numFD, denFD);
        promptHTML = fracFD + " = " + createPowerHTML(base, r);
        explanation =
          "Exponent rule: " + p + " - x - " + q + " = " + r +
          ". So x = " + xValue + ".";
        break;

      } else if (pattern === "fracBothX") {
        // (a^p * a^q) / (a^x * a^r) = a^s
        p = randInt(bounds.expMin, bounds.expMax);
        q = randInt(bounds.expMin, bounds.expMax);
        r = randInt(bounds.expMin, bounds.expMax);
        s = randInt(bounds.finalMin, bounds.finalMax);
        xValue = p + q - r - s;
        if (xValue < -5 || xValue > 10) continue;
        if (!withinExpRange(s)) continue;
        var numFB = createPowerHTML(base, p) +
                    createDotHTML() +
                    createPowerHTML(base, q);
        var denFB = createPowerHTML(base, "x") +
                    createDotHTML() +
                    createPowerHTML(base, r);
        var fracFB = createFractionHTML(numFB, denFB);
        promptHTML = fracFB + " = " + createPowerHTML(base, s);
        explanation =
          "Exponent rule: (" + p + " + " + q + ") - (x + " + r + ") = " + s +
          ". So x = " + xValue + ".";
        break;

      } else if (pattern === "twoX") {
        // a^x * a^x = a^k  => 2x = k
        xValue = randInt(-3, 8);
        var kExp = 2 * xValue;
        if (!withinExpRange(kExp)) continue;
        var leftTX = createPowerHTML(base, "x") +
                     createDotHTML() +
                     createPowerHTML(base, "x");
        var rightTX = createPowerHTML(base, kExp);
        promptHTML = leftTX + " = " + rightTX;
        explanation =
          "Exponent rule: x + x = 2x. So 2x = " + kExp +
          ", which gives x = " + xValue + ".";
        break;
      }
    }

    if (!promptHTML) {
      base = 5;
      xValue = 6;
      promptHTML = createPowerHTML(5, "x") +
        createDotHTML() +
        createPowerHTML(5, 2) + " = " +
        createPowerHTML(5, 8);
      explanation = "Fallback problem: x + 2 = 8, so x = 6.";
    }

    return {
      type: "solve",
      difficulty: difficulty,
      promptHTML: '<span class="equation">' + promptHTML + "</span>",
      answer: {
        kind: "integer",
        value: xValue
      },
      explanationHTML: explanation
    };
  }

  function generateProblem(difficulty, problemMode) {
    var diff = difficulty === "random" ? choose(["easy", "medium", "hard"]) : difficulty;
    var mode = problemMode;
    if (problemMode === "mixed") {
      mode = Math.random() < 0.5 ? "simplify" : "solve";
    }
    if (mode === "solve") {
      return generateSolveForXProblem(diff);
    }
    return generateSimplifyProblem(diff);
  }

  var currentProblem = null;
  var stats = { total: 0, correct: 0, score: 0, streak: 0 };
  var incorrectHistory = [];
  var allowNext = true;
  var timerId = null;
  var timeRemaining = 0;
  var audioCtx = null;

  function playBeep(success) {
    if (!document.getElementById("soundToggle").checked) return;
    try {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      var duration = 0.12;
      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = success ? 880 : 220;
      gain.gain.value = 0.15;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    } catch (e) {}
  }

  var difficultyChips = Array.from(document.querySelectorAll("#difficultyChips .chip"));
  var problemModeChips = Array.from(document.querySelectorAll("#problemModeChips .chip"));
  var questionArea = document.getElementById("questionArea");
  var answerInput = document.getElementById("answerInput");
  var submitBtn = document.getElementById("submitBtn");
  var nextBtn = document.getElementById("nextBtn");
  var clearBtn = document.getElementById("clearBtn");
  var feedbackEl = document.getElementById("feedback");
  var explanationEl = document.getElementById("explanation");
  var showStepsBtn = document.getElementById("showStepsBtn");
  var statTotal = document.getElementById("statTotal");
  var statCorrect = document.getElementById("statCorrect");
  var statAccuracy = document.getElementById("statAccuracy");
  var statScore = document.getElementById("statScore");
  var statStreak = document.getElementById("statStreak");
  var incorrectToggle = document.getElementById("incorrectToggle");
  var incorrectList = document.getElementById("incorrectList");
  var timerDisplay = document.getElementById("timerDisplay");
  var timerToggle = document.getElementById("timerToggle");
  var timerLengthSelect = document.getElementById("timerLengthSelect");
  var mainModeTabs = Array.from(document.querySelectorAll("#mainModeTabs .mode-tab"));
  var gamePane = document.getElementById("gamePane");
  var worksheetPane = document.getElementById("worksheetPane");
  var highContrastToggle = document.getElementById("highContrastToggle");
  var taskLabel = document.getElementById("taskLabel");

  var wsDifficulty = document.getElementById("wsDifficulty");
  var wsProblemMode = document.getElementById("wsProblemMode");
  var wsCount = document.getElementById("wsCount");
  var generateWorksheetBtn = document.getElementById("generateWorksheetBtn");
  var worksheetOutput = document.getElementById("worksheetOutput");
  var wsRevealAllBtn = document.getElementById("wsRevealAllBtn");
  var wsHideAllBtn = document.getElementById("wsHideAllBtn");

  function stopTimer() {
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
    timerDisplay.textContent = "";
  }

  function startTimer() {
    if (!timerToggle.checked) {
      stopTimer();
      return;
    }
    stopTimer();
    var seconds = parseInt(timerLengthSelect.value, 10) || 60;
    timeRemaining = seconds;
    timerDisplay.textContent = timeRemaining + " s";
    timerId = setInterval(function() {
      timeRemaining--;
      if (timeRemaining <= 0) {
        timerDisplay.textContent = "0 s";
        stopTimer();
        if (currentProblem && allowNext) {
          feedbackEl.textContent = "Time is up. Click Next question.";
          feedbackEl.className = "feedback incorrect";
        }
      } else {
        timerDisplay.textContent = timeRemaining + " s";
      }
    }, 1000);
  }

  function getSelectedDifficulty() {
    var chip = difficultyChips.find(function(c) { return c.classList.contains("active"); });
    return chip ? chip.getAttribute("data-diff") : "easy";
  }

  function getSelectedProblemMode() {
    var chip = problemModeChips.find(function(c) { return c.classList.contains("active"); });
    return chip ? chip.getAttribute("data-mode") : "simplify";
  }

  function updateTaskLabel(problem) {
    if (!problem) {
      taskLabel.textContent = "";
      return;
    }
    if (problem.type === "solve") {
      taskLabel.textContent = "Task: Solve for x.";
      answerInput.placeholder = "Type the value of x (e.g. 3)";
    } else {
      taskLabel.textContent = "Task: Simplify the expression.";
      answerInput.placeholder = "Type your answer (e.g. 10^5 or 100 000)";
    }
  }

  function renderProblem(p) {
    currentProblem = p;
    allowNext = false;
    updateTaskLabel(p);
    questionArea.innerHTML = p.promptHTML;
    answerInput.value = "";
    answerInput.focus();
    feedbackEl.textContent = "";
    feedbackEl.className = "feedback";
    explanationEl.innerHTML = p.explanationHTML || "";
    explanationEl.classList.add("hidden");
    showStepsBtn.style.display = p.explanationHTML ? "inline-flex" : "none";
    if (timerToggle.checked) startTimer();
  }

  function newProblem() {
    var diff = getSelectedDifficulty();
    var mode = getSelectedProblemMode();
    var p = generateProblem(diff, mode);
    renderProblem(p);
  }

  function checkAnswer() {
    if (!currentProblem) {
      feedbackEl.textContent = "Click Next question to start.";
      return;
    }
    var raw = answerInput.value.trim();
    if (!raw) {
      feedbackEl.textContent = "Type an answer first.";
      feedbackEl.className = "feedback";
      return;
    }
    if (timerToggle.checked && !timerId && timeRemaining === 0) {
      feedbackEl.textContent = "Time is up. Click Next question.";
      feedbackEl.className = "feedback incorrect";
      return;
    }
    stopTimer();

    var correct = false;
    var correctDisplay = "";

    if (currentProblem.answer.kind === "power") {
      var base = currentProblem.answer.base;
      var exp = currentProblem.answer.exp;
      var value = currentProblem.answer.value;
      correctDisplay = createPowerHTML(base, exp);

      var parsed = parsePowerAnswer(raw);
      if (parsed && parsed.type === "power") {
        correct = (parsed.base === base && parsed.exp === exp);
      } else if (parsed && parsed.type === "integer") {
        correct = (parsed.value === value);
      }
    } else if (currentProblem.answer.kind === "integer") {
      var v = parseInt(raw.replace(/\s+/g, ""), 10);
      correct = (!isNaN(v) && v === currentProblem.answer.value);
      correctDisplay = currentProblem.answer.value.toString();
    } else if (currentProblem.answer.kind === "fraction") {
      var parsedFrac = parseFractionAnswer(raw);
      var ans = currentProblem.answer;
      correct = parsedFrac &&
        parsedFrac.num === ans.num && parsedFrac.den === ans.den;
      correctDisplay = createFractionHTML(ans.num, ans.den);
    } else if (currentProblem.answer.kind === "integerValueOnly") {
      var numv = parseInt(raw.replace(/\s+/g, ""), 10);
      correct = (!isNaN(numv) && numv === currentProblem.answer.value);
      correctDisplay = formatIntegerSpaces(currentProblem.answer.value);
    }

    stats.total++;
    if (correct) {
      stats.correct++;
      stats.streak++;
      stats.score += 10;
      if (stats.streak % 5 === 0) stats.score += 5;
      feedbackEl.textContent = "Correct!";
      feedbackEl.className = "feedback correct";
      playBeep(true);
    } else {
      stats.streak = 0;
      feedbackEl.innerHTML = "Incorrect. Correct answer: " + correctDisplay;
      feedbackEl.className = "feedback incorrect";
      playBeep(false);
      incorrectHistory.push({
        prompt: currentProblem.promptHTML,
        answer: correctDisplay,
        yourAnswer: escapeHTML(raw)
      });
      renderIncorrectList();
    }
    updateStatsDisplay();
    allowNext = true;
  }

  function updateStatsDisplay() {
    statTotal.textContent = stats.total;
    statCorrect.textContent = stats.correct;
    var acc = stats.total === 0 ? 0 : Math.round((stats.correct / stats.total) * 100);
    statAccuracy.textContent = acc + "%";
    statScore.textContent = stats.score;
    statStreak.textContent = stats.streak;
  }

  function renderIncorrectList() {
    if (!incorrectHistory.length) {
      incorrectList.innerHTML = "<p>No incorrect questions yet.</p>";
      return;
    }
    var html = "<ul>";
    incorrectHistory.forEach(function(item, index) {
      html += "<li><strong>Q" + (index + 1) + ":</strong> " +
        item.prompt + " â†’ Correct: " + item.answer +
        " (Your answer: " + item.yourAnswer + ")</li>";
    });
    html += "</ul>";
    incorrectList.innerHTML = html;
  }

  function generateWorksheet() {
    var count = parseInt(wsCount.value, 10) || 10;
    var diff = wsDifficulty.value;
    var mode = wsProblemMode.value;

    var html = "<h3>Worksheet â€“ " + count + " questions</h3>";
    html += '<p style="font-size:0.85rem; color:var(--fg-soft); text-align:center;">' +
      'Simplify the expression or solve for x, as instructed.</p>';

    html += "<ol style=\"padding-left: 18px;\">";
    for (var i = 0; i < count; i++) {
      var p = generateProblem(diff, mode);
      var correctDisplay = "";
      if (p.answer.kind === "power") {
        correctDisplay = createPowerHTML(p.answer.base, p.answer.exp);
      } else if (p.answer.kind === "integer") {
        correctDisplay = escapeHTML(p.answer.value.toString());
      } else if (p.answer.kind === "fraction") {
        correctDisplay = createFractionHTML(p.answer.num, p.answer.den);
      } else if (p.answer.kind === "integerValueOnly") {
        correctDisplay = formatIntegerSpaces(p.answer.value);
      }

      var label = "";
      if (p.type === "solve") {
        label = '<span style="font-size:0.85rem; color:var(--fg-soft);">Solve for x: </span>';
      }

      html += "<li class=\"worksheet-item\">" + label + p.promptHTML +
        "<div class=\"worksheet-answer\" data-index=\"" + i + "\">Answer: " +
        correctDisplay + "</div></li>";
    }
    html += "</ol>";
    worksheetOutput.innerHTML = html;

    Array.from(worksheetOutput.querySelectorAll(".worksheet-item")).forEach(function(li) {
      li.addEventListener("click", function() {
        var ans = li.querySelector(".worksheet-answer");
        ans.classList.toggle("visible");
      });
    });
  }

  function setWorksheetAnswersVisible(visible) {
    Array.from(worksheetOutput.querySelectorAll(".worksheet-answer"))
      .forEach(function(el) {
        if (visible) el.classList.add("visible");
        else el.classList.remove("visible");
      });
  }

  difficultyChips.forEach(function(chip) {
    chip.addEventListener("click", function() {
      difficultyChips.forEach(function(c) { c.classList.remove("active"); });
      chip.classList.add("active");
    });
  });

  problemModeChips.forEach(function(chip) {
    chip.addEventListener("click", function() {
      problemModeChips.forEach(function(c) { c.classList.remove("active"); });
      chip.classList.add("active");
    });
  });

  submitBtn.addEventListener("click", checkAnswer);
  nextBtn.addEventListener("click", newProblem);
  clearBtn.addEventListener("click", function() {
    answerInput.value = "";
    answerInput.focus();
  });

  answerInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      if (!currentProblem || !allowNext) {
        checkAnswer();
      } else if (allowNext) {
        newProblem();
      }
    } else if (e.key === "Escape") {
      answerInput.value = "";
    }
  });

  showStepsBtn.addEventListener("click", function() {
    explanationEl.classList.toggle("hidden");
  });

  incorrectToggle.addEventListener("click", function() {
    if (!incorrectHistory.length) {
      incorrectList.innerHTML = "<p>No incorrect questions yet.</p>";
    }
    var visible = incorrectList.style.display === "block";
    incorrectList.style.display = visible ? "none" : "block";
    incorrectToggle.textContent = visible
      ? "Show incorrect questions"
      : "Hide incorrect questions";
  });

  timerToggle.addEventListener("change", function() {
    if (timerToggle.checked && currentProblem) {
      startTimer();
    } else {
      stopTimer();
    }
  });

  timerLengthSelect.addEventListener("change", function() {
    if (timerToggle.checked && currentProblem) {
      startTimer();
    }
  });

  mainModeTabs.forEach(function(tab) {
    tab.addEventListener("click", function() {
      mainModeTabs.forEach(function(t) { t.classList.remove("active"); });
      tab.classList.add("active");
      var mode = tab.getAttribute("data-main-mode");
      if (mode === "game") {
        gamePane.style.display = "block";
        worksheetPane.style.display = "none";
      } else {
        gamePane.style.display = "none";
        worksheetPane.style.display = "block";
      }
    });
  });

  highContrastToggle.addEventListener("change", function() {
    if (highContrastToggle.checked) {
      document.body.classList.add("high-contrast");
    } else {
      document.body.classList.remove("high-contrast");
    }
  });

  generateWorksheetBtn.addEventListener("click", generateWorksheet);
  wsRevealAllBtn.addEventListener("click", function() {
    setWorksheetAnswersVisible(true);
  });
  wsHideAllBtn.addEventListener("click", function() {
    setWorksheetAnswersVisible(false);
  });

  function runDevTests() {
    var container = document.getElementById("devTests");
    container.style.display = "block";
    var results = [];

    function addResult(name, ok, detail) {
      results.push({ name: name, ok: ok, detail: detail || "" });
    }

    ["easy", "medium", "hard"].forEach(function(diff) {
      var bounds = getExponentBounds(diff);
      var ok = true;
      for (var i = 0; i < 80; i++) {
        var p = generateSimplifyProblem(diff);
        if (p.answer.kind === "power") {
          var e = p.answer.exp;
          if (e < bounds.finalMin || e > bounds.finalMax ||
              (!bounds.allowNegative && e < 0)) {
            ok = false;
            break;
          }
        }
      }
      addResult("Simplify exponent bounds (" + diff + ")", ok);
    });

    (function() {
      var ok = true;
      for (var i = 0; i < 60; i++) {
        var p = generateSimplifyProblem("medium");
        if (BASES.indexOf(p.answer.base) === -1) {
          ok = false;
          break;
        }
      }
      addResult("Base always in allowed set", ok);
    })();

    (function() {
      var ok = true;
      for (var i = 0; i < 60; i++) {
        var p = generateSolveForXProblem("hard");
        if (p.answer.kind !== "integer" ||
            typeof p.answer.value !== "number" ||
            !isFinite(p.answer.value)) {
          ok = false;
          break;
        }
      }
      addResult("Solve-for-x gives integer solutions", ok);
    })();

    (function() {
      var ok = true;
      for (var i = 0; i < 60; i++) {
        var p = generateSimplifyProblem("easy");
        if (p.answer.kind === "power" && p.answer.exp < 0) {
          ok = false;
          break;
        }
      }
      addResult("Easy never produces negative exponent", ok);
    })();

    (function() {
      var ok = true;
      try {
        for (var i = 0; i < 10; i++) {
          generateProblem("random", "mixed");
        }
      } catch (e) {
        ok = false;
      }
      addResult("Mixed generator works", ok);
    })();

    (function() {
      var p1 = parsePowerAnswer("10^5");
      var p2 = parsePowerAnswer("100000");
      var ok = p1 && p1.type === "power" && p1.base === 10 && p1.exp === 5 &&
        p2 && p2.type === "integer" && p2.value === 100000;
      addResult("Power answer parser handles 10^5 and 100000", ok);
    })();

    (function() {
      var f = parseFractionAnswer("2/4");
      var ok = f && f.num === 1 && f.den === 2;
      addResult("Fraction parser simplifies 2/4 to 1/2", ok);
    })();

    (function() {
      var s1 = formatIntegerSpaces(1000000);
      var s2 = formatIntegerSpaces(123456789);
      var ok = (s1 === "1 000 000") && (s2 === "123 456 789");
      addResult("Thousands separated by spaces", ok);
    })();

    (function() {
      var ok = true;
      try {
        timerToggle.checked = true;
        startTimer();
        stopTimer();
        timerToggle.checked = false;
      } catch (e) {
        ok = false;
      }
      addResult("Timer start/stop safe", ok);
    })();

    (function() {
      var ok = true;
      try {
        for (var i = 0; i < 50; i++) {
          generateProblem("random", "mixed");
        }
      } catch (e) {
        ok = false;
      }
      addResult("Generate 50 problems without error", ok);
    })();

    var html = "<h3>Developer tests (?dev=1)</h3><ul>";
    results.forEach(function(r) {
      html += '<li class="' + (r.ok ? "pass" : "fail") + '">[' +
        (r.ok ? "PASS" : "FAIL") + "] " + escapeHTML(r.name) +
        (r.detail ? " â€“ " + escapeHTML(r.detail) : "") + "</li>";
    });
    html += "</ul>";
    container.innerHTML = html;
  }

  (function init() {
    var params = new URLSearchParams(window.location.search);
    if (params.get("dev") === "1") {
      runDevTests();
    }
  })();

})();
</script>
</body>
</html>
